const express=require("express"),fs=require("fs"),{Client,MessageMedia}=require("whatsapp-web.js"),app=express();app.use(express.json({limit:"16mb"}));const SESSION_FILE_PATH="./session.json";let sessionCfg;fs.existsSync(SESSION_FILE_PATH)&&(sessionCfg=require(SESSION_FILE_PATH));const client=new Client({puppeteer:{headless:!1},session:sessionCfg});client.initialize(),app.listen(5555,()=>console.log("Listening on port 5555")),client.on("qr",s=>{app.get("/qr",(e,n)=>{n.send(s)}),console.log("QR RECEIVED")}),client.on("authenticated",s=>{console.log("AUTHENTICATED",s),sessionCfg=s,fs.writeFile(SESSION_FILE_PATH,JSON.stringify(s),function(e){e&&console.error(e)})}),client.on("auth_failure",s=>{console.error("AUTHENTICATION FAILURE",s),fs.writeFile("../session.json","{}",function(e){console.log(`Error ${e}`)})}),client.on("ready",()=>{console.log("Client is ready!"),app.get("/",(s,e)=>{e.send("Hiii!")}),app.post("/send-msg",(s,e)=>{const{number:n,msg:o}=s.body;client.sendMessage(`91${n}@c.us`,o).then(()=>e.send("Message sent successfully")).catch(t=>e.send(t).status(500))}),app.post("/send-media",(s,e)=>{const{number:n,mimetype:o,base64:t}=s.body,i=new MessageMedia(o,t,Date.now().toString());client.sendMessage(`91${n}@c.us`,i).then(()=>e.send("Media sent successfully")).catch(c=>e.send(c).status(500))}),app.get("/logout",async(s,e)=>{await client.logout(),e.send("Logged out"),fs.unlink(SESSION_FILE_PATH,()=>console.log("Session deleted")),process.exit()})});
